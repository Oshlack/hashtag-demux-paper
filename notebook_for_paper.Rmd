---
title: "Hashtag paper notebook"
author: "George Howitt"
date: "2022-12-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r}
#Load libraries
suppressPackageStartupMessages({
library(here)
library(BiocStyle)
library(dplyr)
library(janitor)
library(ggplot2)
library(cowplot)
library(patchwork)
library(DropletUtils)
library(tidyverse)
library(scuttle)
library(scater)
library(Seurat)
library(pheatmap)
library(speckle)
library(dittoSeq)
library(cellhashR)
library(RColorBrewer)
library(demuxmix)
})
```

#BAL data set

##Data loading and reduction

Load in matrices
```{r}
batch1_counts <- read.csv(here("data", "batch1_hto_counts.csv"), check.names = FALSE, row.names = 1)
batch2_counts <- read.csv(here("data", "batch2_hto_counts.csv"), check.names = FALSE, row.names = 1)
batch3_counts <- read.csv(here("data", "batch3_hto_counts.csv"), check.names = FALSE, row.names = 1)
```
```{r}
batch1_donors <- read.csv(here("data", "batch1_donors"), row.names = 1)
batch2_donors <- read.csv(here("data", "batch2_donors"), row.names = 1)
batch3_donors <- read.csv(here("data", "batch3_donors"), row.names = 1)
```

Make Seurat objects
```{r}
seu1 <- CreateSeuratObject(counts = batch1_counts, assay = "HTO")
seu2 <- CreateSeuratObject(counts = batch2_counts, assay = "HTO")
seu3 <- CreateSeuratObject(counts = batch3_counts, assay = "HTO")
```
```{r}
seu1$Barcode <- colnames(seu1)
seu2$Barcode <- colnames(seu2)
seu3$Barcode <- colnames(seu3)
```

Add genetic donor information to Seurat objects
```{r}
seu1$genetic_donor <- batch1_donors
seu2$genetic_donor <- batch2_donors
seu3$genetic_donor <- batch3_donors
```

For each of the batches need a list of the HTOs and the associated genetic donors.
```{r}
HTO_list_batch1 <- c("Human-HTO-1", "Human-HTO-2", "Human-HTO-3", "Human-HTO-4", "Human-HTO-5", "Human-HTO-6", "Human-HTO-7", "Human-HTO-8", "Doublet", "Negative")

donor_list_batch1 <- list("donor_A" = "Human-HTO-3", "donor_B" = "Human-HTO-1", "donor_C" = "Human-HTO-4", "donor_D" = "Human-HTO-2", "donor_E" = "Human-HTO-8", "donor_F" = "Human-HTO-6", "donor_G" = "Human-HTO-5", "donor_H" = "Human-HTO-7", "doublet" = "Doublet", "unassigned" = "Negative")

HTO_list_batch2 <- c("Human-HTO-6", "Human-HTO-7", "Human-HTO-9", "Human-HTO-10", "Human-HTO-12", "Human-HTO-13", "Human-HTO-14", "Human-HTO-15", "Doublet", "Negative")

donor_list_batch2 <- list("donor_A" = "Human-HTO-7", "donor_B" = "Human-HTO-13", "donor_C" = "Human-HTO-15", "donor_D" = "Human-HTO-12", "donor_E" = "Human-HTO-6", "donor_F" = "Human-HTO-9", "donor_G" = "Human-HTO-14", "donor_H" = "Human-HTO-10",
                          "doublet" = "Doublet", "unassigned" = "Negative")

donor_list_batch3 <- list("donor_A" = "Human-HTO-6", "donor_B" = "Human-HTO-10", "donor_C" = "Human-HTO-14", "donor_D" = "Human-HTO-13", "donor_E" = "Human-HTO-15", "donor_F" = "Human-HTO-7", "donor_G" = "Human-HTO-12", "donor_H" = "Human-HTO-9", "doublet" = "Doublet", "unassigned" = "Negative")

HTO_list_batch3 <- c("Human-HTO-6", "Human-HTO-7", "Human-HTO-9", "Human-HTO-10", 
                     "Human-HTO-12", "Human-HTO-13", "Human-HTO-14", "Human-HTO-15", "Doublet", "Negative")

HTO_donor_list_batch1 <- list("Doublet" = "doublet", "Human-HTO-1" = "donor_B", "Human-HTO-2" = "donor_D", "Human-HTO-3" = "donor_A", "Human-HTO-4" = "donor_C", "Human-HTO-5" = "donor_G", "Human-HTO-6" = "donor_F", "Human-HTO-7" = "donor_H", "Human-HTO-8" = "donor_E", "Negative" = "unassigned")

HTO_donor_list_batch2 <- list("Doublet" = "doublet", "Human-HTO-10" = "donor_H", "Human-HTO-12" = "donor_D", "Human-HTO-13" = "donor_B", "Human-HTO-14" = "donor_G", "Human-HTO-15" = "donor_C", "Human-HTO-6" = "donor_E", "Human-HTO-7" = "donor_A", "Human-HTO-9" = "donor_F", "Negative" = "unassigned")

HTO_donor_list_batch3 <- list("Doublet" = "doublet", "Human-HTO-10" = "donor_B", "Human-HTO-12" = "donor_G", "Human-HTO-13" = "donor_D", "Human-HTO-14" = "donor_C", "Human-HTO-15" = "donor_E", "Human-HTO-6" = "donor_A", "Human-HTO-7" = "donor_F", "Human-HTO-9" = "donor_H", "Negative" = "unassigned")

```

Compute PCAs and tSNEs
```{r}
DefaultAssay(seu1) <- "HTO"
seu1 <- NormalizeData(seu1, assay = "HTO", normalization.method = "CLR")
seu1 <- ScaleData(seu1, features = rownames(seu1),
    verbose = FALSE)
seu1 <- RunPCA(seu1, features = rownames(seu1), approx = FALSE, verbose = FALSE)
seu1 <- RunTSNE(seu1, dims = 1:8, perplexity = 100, check_duplicates = FALSE, verbose = FALSE)

DefaultAssay(seu2) <- "HTO"
seu2 <- NormalizeData(seu2, assay = "HTO", normalization.method = "CLR")
seu2 <- ScaleData(seu2, features = rownames(seu2),
    verbose = FALSE)
seu2 <- RunPCA(seu2, features = rownames(seu2), approx = FALSE, verbose = FALSE)
seu2 <- RunTSNE(seu2, dims = 1:8, perplexity = 100, check_duplicates = FALSE, verbose = FALSE)

DefaultAssay(seu3) <- "HTO"
seu3 <- NormalizeData(seu3, assay = "HTO", normalization.method = "CLR")
seu3 <- ScaleData(seu3, features = rownames(seu3),
    verbose = FALSE)
seu3 <- RunPCA(seu3, features = rownames(seu3), approx = FALSE, verbose = FALSE)
seu3 <- RunTSNE(seu3, dims = 1:8, perplexity = 100, check_duplicates = FALSE, verbose = FALSE)
```

##QC plots

Density plots
```{r}
df1 <- as.data.frame(t(seu1[["HTO"]]@counts))
colnames(df1) <- gsub("_", " ", HTO_donor_list_batch1[colnames(df1)])
df1 %>%
  pivot_longer(cols = starts_with("donor")) %>%
  mutate(logged = log(value + 1)) %>%
  ggplot(aes(x = logged)) +
  xlab("log(counts)") +
  xlim(0.1,8) +
  ggtitle("Batch 1") +
  geom_density(adjust = 5) +
  facet_wrap(~name, scales = "fixed", ncol = 4) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank()) -> p1

df2 <- as.data.frame(t(seu2[["HTO"]]@counts))
colnames(df2) <- gsub("_", " ", HTO_donor_list_batch2[colnames(df2)])
df2 %>%
  pivot_longer(cols = starts_with("donor")) %>%
  mutate(logged = log(value + 1)) %>%
  ggplot(aes(x = logged)) +
  xlab("log(counts)") +
  xlim(0.1, 8) +
  ggtitle("Batch 2") +
  geom_density(adjust = 5) +
  facet_wrap(~forcats::fct_relevel(name, "donor A", "donor B", "donor C", "donor D", "donor E", "donor F", "donor G", "donor H"),
                                   #"Human-HTO-6", "Human-HTO-7", "Human-HTO-9", "Human-HTO-10", "Human-HTO-12", "Human-HTO-13", "Human-HTO-14", "Human-HTO-15"), 
             scales = "fixed", ncol = 4) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) -> p2

df3 <- as.data.frame(t(seu3[["HTO"]]@counts))
colnames(df3) <- gsub("_", " ", HTO_donor_list_batch3[colnames(df3)])
df3 %>%
  pivot_longer(cols = starts_with("donor")) %>%
  mutate(logged = log(value + 1)) %>%
  ggplot(aes(x = logged)) +
  xlab("log(counts)") +
  xlim(0.1,8) +
  ggtitle("Batch 3") +
   geom_density(adjust = 5) +
  facet_wrap(~forcats::fct_relevel(name, "donor A", "donor B", "donor C", "donor D", "donor E", "donor F", "donor G", "donor H"),
                                   #"Human-HTO-6", "Human-HTO-7", "Human-HTO-9", "Human-HTO-10", "Human-HTO-12", "Human-HTO-13", "Human-HTO-14", "Human-HTO-15"), 
             scales = "fixed", ncol = 4) +
  theme(#axis.title.y = element_blank(),
        #axis.text.y = element_blank(),
        axis.ticks = element_blank()) -> p3

(p1 / p2 / p3) + plot_annotation(tag_levels = 'a')
```

##Hashtag-based demultiplexing. 

###hashedDrops

This function creates a list of hashedDrops calls. Its defaults are the same as hashedDrops
```{r}
create_hashedDrops_factor <- function(seurat_object, confident.min = 2,
                              doublet.nmads = 3, doublet.min = 2) {
  hto_counts <- GetAssayData(seurat_object[["HTO"]], slot = "counts")
  hash_stats <- DropletUtils::hashedDrops(hto_counts, confident.min = confident.min,
                                          doublet.nmads = doublet.nmads, doublet.min = doublet.min)
  
  hash_stats$Best <- rownames(seurat_object[["HTO"]])[hash_stats$Best]
  hash_stats$Second <- rownames(seurat_object[["HTO"]])[hash_stats$Second]
  
  HTO_assignments <- factor(case_when(
    hash_stats$Confident == TRUE ~ hash_stats$Best,
    hash_stats$Doublet == TRUE ~ "Doublet",
    TRUE ~ "Negative"))
  return(HTO_assignments)
  }
```

Making factors with best parameters
```{r}
seu1$hashedDrops_calls <- create_hashedDrops_factor(seu1, confident.min = 0.5, doublet.nmads = 3, doublet.min = 2)
seu2$hashedDrops_calls <- create_hashedDrops_factor(seu2, confident.min = 0.5, doublet.nmads = 3, doublet.min = 2)
seu3$hashedDrops_calls <- create_hashedDrops_factor(seu3, confident.min = 0.5, doublet.nmads = 3, doublet.min = 2)
```

Now with default parameters
```{r}
seu1$hashedDrops_default_calls <- create_hashedDrops_factor(seu1)
seu2$hashedDrops_default_calls <- create_hashedDrops_factor(seu2)
seu3$hashedDrops_default_calls <- create_hashedDrops_factor(seu3)
```

###HTODemux
```{r}
HDmux <- HTODemux(seu1)
seu1$HTODemux_calls <- HDmux$hash.ID
HDmux <- HTODemux(seu2)
seu2$HTODemux_calls <- HDmux$hash.ID
HDmux <- HTODemux(seu3)
seu3$HTODemux_calls <- HDmux$hash.ID
```

###GMM-Demux

GMM-Demux is run on the command line and needs a function to read in the results and format them all properly.
```{r}
create_gmm_demux_factor <- function(seu, GMM_path, hto_list) {
  #Read in output, have to use the "full" report, not the simplified one.
  calls <- read.csv(paste0(GMM_path, "/GMM_full.csv"), row.names = 1)
  #Read in names of clusters
  cluster_names <- read.table(paste0(GMM_path, "/GMM_full.config"), sep = ",")
  names(cluster_names) <- c("Cluster_id", "assignment")
  #Need to fix the formatting of the assignment names, for some reason there's a leading space.
  cluster_names$assignment <- gsub(x = cluster_names$assignment, pattern = '^ ', replacement = '')
  #Add cell barcodes 
  calls$Barcode <- rownames(calls)
  calls <- merge(calls, cluster_names, by = "Cluster_id", sort = FALSE)
  #Need to re-order after merge for some reason
  calls <- calls[order(match(calls$Barcode, names(seu$Barcode))), ]
  #Rename the negative cluster for consistency
  calls$assignment[calls$assignment == "negative"] <- "Negative"
  #Put all the multiplet states into one assignment category
  calls$assignment[!calls$assignment %in% c("Negative", hto_list)] <- "Doublet"
  return(as.factor(calls$assignment))
}
```

Need to write transpose of counts matrices to .csv files to run GMM-Demux on command line. 
```{r}
write.csv(t(as.matrix(batch1_counts)), here("data", "GMM_Demux", "batch1_hto_counts_transpose.csv"))
write.csv(t(as.matrix(batch2_counts)), here("data", "GMM_Demux", "batch2_hto_counts_transpose.csv"))
write.csv(t(as.matrix(batch3_counts)), here("data", "GMM_Demux", "batch3_hto_counts_transpose.csv"))
```

See script for running GMM-Demux

Add to objects
```{r}
#Batch 1
seu1$GMMDemux_calls <- create_gmm_demux_factor(seu1, here("data", "GMM_Demux", "gmm_out_batch1", "full_report_t_0.8"), HTO_list_batch1) 
seu2$GMMDemux_calls <- create_gmm_demux_factor(seu2, here("data", "GMM_Demux", "gmm_out_batch5", "full_report_t_0.8"), HTO_list_batch2) 
seu3$GMMDemux_calls <- create_gmm_demux_factor(seu3, here("data", "GMM_Demux", "gmm_out_batch3", "full_report_t_0.8"), HTO_list_batch3) 
```

###deMULTIplex

Next is deMULTIplex, using the Seurat wrapper function MULTIseqDemux for this
```{r}
seu1$deMULTIplex_calls <- MULTIseqDemux(seu1, autoThresh = TRUE)$MULTI_ID
seu2$deMULTIplex_calls <- MULTIseqDemux(seu2, autoThresh = TRUE)$MULTI_ID
seu3$deMULTIplex_calls <- MULTIseqDemux(seu3, autoThresh = TRUE)$MULTI_ID
```

###BFF
Finally cellhashR's BFF_raw and BFF_cluster methods.
Need to run this on the raw counts matrix
```{r}
batch1_hto_counts <- seu1[["HTO"]]@counts
batch2_hto_counts <- seu2[["HTO"]]@counts
batch3_hto_counts <- seu3[["HTO"]]@counts
```

```{r}
cellhashR_calls <- GenerateCellHashingCalls(barcodeMatrix = batch1_hto_counts, methods = c("bff_raw", "bff_cluster"), doTSNE = FALSE, doHeatmap = FALSE)
```

```{r}
seu1$BFF_raw_calls <- cellhashR_calls$bff_raw
seu1$BFF_cluster_calls <- cellhashR_calls$bff_cluster
```

```{r}
cellhashR_calls <- GenerateCellHashingCalls(barcodeMatrix = batch2_hto_counts, methods = c("bff_raw", "bff_cluster"), doTSNE = FALSE, doHeatmap = FALSE)
```

```{r}
seu2$BFF_raw_calls <- cellhashR_calls$bff_raw
#seu2$BFF_cluster_calls <- cellhashR_calls$bff_cluster 
#Note! BFF_cluster does not work at all on batch 2. 
seu2$BFF_cluster_calls <- as.factor(rep("Negative", ncol(seu2)))
```

```{r}
cellhashR_calls <- GenerateCellHashingCalls(barcodeMatrix = batch3_hto_counts, methods = c("bff_raw", "bff_cluster"), doTSNE = FALSE, doHeatmap = FALSE)
```

```{r}
seu3$BFF_raw_calls <- cellhashR_calls$bff_raw
seu3$BFF_cluster_calls <- cellhashR_calls$bff_cluster
```

###demuxmix

This has two flavours, one which takes into account the RNA library size and one which works just on the hashtag libraries. The latter doesn't change the results much and requires the RNA counts matrix so we'll just use the basic version.

This function turns the output of demuxmix into something consistent with the other methods
```{r}
demuxmix_calls_consistent <- function(seurat_object, model = "naive", hto_list) {
  hto_counts <- as.matrix(GetAssayData(seurat_object[["HTO"]], slot = "counts"))
  dmm <- demuxmix(hto_counts, model = model)
  dmm_calls <- dmmClassify(dmm)
  calls_out <- case_when(dmm_calls$HTO %in% hto_list ~ dmm_calls$HTO,
               !dmm_calls$HTO %in% hto_list ~ case_when(
                 dmm_calls$Type == "multiplet" ~ "Doublet",
                 dmm_calls$Type %in% c("negative", "uncertain") ~ "Negative")
               )
  return(as.factor(calls_out))
}
```
```{r}
seu1$demuxmix_calls <- demuxmix_calls_consistent(seu1, hto_list = HTO_list_batch1)
seu2$demuxmix_calls <- demuxmix_calls_consistent(seu2, hto_list = HTO_list_batch2)
seu3$demuxmix_calls <- demuxmix_calls_consistent(seu3, hto_list = HTO_list_batch3)
```

Add a factor for batches
```{r}
seu1$Batch <- "Batch 1"
seu2$Batch <- "Batch 2"
seu3$Batch <- "Batch 3"
```

##Plots

Making category plots (i.e. Figure 2)
```{r}
method_calls <- c("hashedDrops_calls", "hashedDrops_default_calls", "HTODemux_calls", "GMMDemux_calls",
                  "deMULTIplex_calls", "BFF_raw_calls", "BFF_cluster_calls", "demuxmix_calls")

for (method in method_calls){ 
  seu1[[gsub(method, paste0(method, "_donors"), method)]] <- as.factor(unlist(HTO_list_batch1[unlist(seu1[[method]])]))
  seu2[[gsub(method, paste0(method, "_donors"), method)]] <- as.factor(unlist(HTO_list_batch2[unlist(seu2[[method]])]))
  seu3[[gsub(method, paste0(method, "_donors"), method)]] <- as.factor(unlist(HTO_list_batch3[unlist(seu3[[method]])]))
}

seu <- merge(seu1, c(seu2, seu3))
seu$Batch <- as.factor(seu$Batch)
```

```{r}
sd_or_u_hashtags <- function(seurat_object, method) {
  return(case_when(seurat_object[[method]] == "Doublet" ~ "Doublet",
            seurat_object[[method]] == "Negative" ~ "Negative",
            TRUE ~ "Singlet"))
}

for (method in method_calls) {
  seu[[gsub(method, paste0(method, "_category"), method)]] <- sd_or_u_hashtags(seu, method)
}
seu$genetic_donor_category <- case_when(seu$genetic_donor == "doublet" ~ "Doublet",
                                        seu$genetic_donor == "unassigned" ~ "Negative",
                                        TRUE ~ "Singlet")

```

```{r}
p1 <- dittoBarPlot(seu, var = "genetic_donor_category", group.by = "Batch") + NoLegend() +
  ggtitle("vireo (genetics)") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank())
p2 <- dittoBarPlot(seu, var = "hashedDrops_calls_category", group.by = "Batch") + NoLegend() + 
  ggtitle("hashedDrops - best") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank(), axis.text.y = element_blank())
p3 <- dittoBarPlot(seu, var = "hashedDrops_default_calls_category", group.by = "Batch") + NoLegend() + 
  ggtitle("hashedDrops - default") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank(), axis.text.y = element_blank())
p4 <- dittoBarPlot(seu, var = "HTODemux_calls_category", group.by = "Batch") + NoLegend() +
  ggtitle("HTODemux") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank())
p5 <- dittoBarPlot(seu, var = "GMMDemux_calls_category", group.by = "Batch") + NoLegend() + 
  ggtitle("GMM-Demux") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank(), axis.text.y = element_blank())
p6 <- dittoBarPlot(seu, var = "deMULTIplex_calls_category", group.by = "Batch") + 
  ggtitle("deMULTIplex") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank(), axis.text.y = element_blank())
p7 <- dittoBarPlot(seu, var = "BFF_raw_calls_category", group.by = "Batch") + NoLegend() + 
  ggtitle("BFF_raw") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank())
p8 <- dittoBarPlot(seu, var = "BFF_cluster_calls_category", group.by = "Batch") + NoLegend() + 
  ggtitle("BFF_cluster") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.y = element_blank())
p9 <- dittoBarPlot(seu, var = "demuxmix_calls_category", group.by = "Batch") + NoLegend() +
  ggtitle("demuxmix") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.y = element_blank())


(p1 + p2 + p3) / (p4 + p5 + p6) / (p7 + p8 + p9)
```

###Calculating F-score

```{r}
calculate_HTO_fscore <- function(seurat_object, donor_hto_list, method) {
  calls <- seurat_object[[method]]
  f <- NULL
  for (HTO in donor_hto_list) {
    tp <- sum(calls == HTO & donor_hto_list[seurat_object$genetic_donor] == HTO) #True positive rate
    fp <- sum(calls == HTO & donor_hto_list[seurat_object$genetic_donor] != HTO) #False positive rate
    fn <- sum(calls != HTO & donor_hto_list[seurat_object$genetic_donor] == HTO) #False negative rate
    f <- c(f, tp / (tp + 0.5 * (fp + fn)))
  }
  f <- c(f, median(f)) #Add median F score
  names(f) <- c(donor_hto_list, "Median")
  
  return(f)
}
```

```{r}
Fscore_hashedDrops_batch1 <- calculate_HTO_fscore(seu1, donor_list_batch1[1:8], "hashedDrops_calls")
Fscore_hashedDrops_batch2 <- calculate_HTO_fscore(seu2, donor_list_batch2[1:8], "hashedDrops_calls")
Fscore_hashedDrops_batch3 <- calculate_HTO_fscore(seu3, donor_list_batch3[1:8], "hashedDrops_calls")

Fscore_hashedDrops_default_batch1 <- calculate_HTO_fscore(seu1, donor_list_batch1[1:8], "hashedDrops_default_calls")
Fscore_hashedDrops_default_batch2 <- calculate_HTO_fscore(seu2, donor_list_batch2[1:8], "hashedDrops_default_calls")
Fscore_hashedDrops_default_batch3 <- calculate_HTO_fscore(seu3, donor_list_batch3[1:8], "hashedDrops_default_calls")

Fscore_HTODemux_batch1 <- calculate_HTO_fscore(seu1, donor_list_batch1[1:8], "HTODemux_calls")
Fscore_HTODemux_batch2 <- calculate_HTO_fscore(seu2, donor_list_batch2[1:8], "HTODemux_calls")
Fscore_HTODemux_batch3 <- calculate_HTO_fscore(seu3, donor_list_batch3[1:8], "HTODemux_calls")

Fscore_GMMDemux_batch1 <- calculate_HTO_fscore(seu1, donor_list_batch1[1:8], "GMMDemux_calls")
Fscore_GMMDemux_batch2 <- calculate_HTO_fscore(seu2, donor_list_batch2[1:8], "GMMDemux_calls")
Fscore_GMMDemux_batch3 <- calculate_HTO_fscore(seu3, donor_list_batch3[1:8], "GMMDemux_calls")

Fscore_deMULTIplex_batch1 <- calculate_HTO_fscore(seu1, donor_list_batch1[1:8], "deMULTIplex_calls")
Fscore_deMULTIplex_batch2 <- calculate_HTO_fscore(seu2, donor_list_batch2[1:8], "deMULTIplex_calls")
Fscore_deMULTIplex_batch3 <- calculate_HTO_fscore(seu3, donor_list_batch3[1:8], "deMULTIplex_calls")

Fscore_BFF_raw_batch1 <- calculate_HTO_fscore(seu1, donor_list_batch1[1:8], "BFF_raw_calls")
Fscore_BFF_raw_batch2 <- calculate_HTO_fscore(seu2, donor_list_batch2[1:8], "BFF_raw_calls")
Fscore_BFF_raw_batch3 <- calculate_HTO_fscore(seu3, donor_list_batch3[1:8], "BFF_raw_calls")

Fscore_BFF_cluster_batch1 <- calculate_HTO_fscore(seu1, donor_list_batch1[1:8], "BFF_cluster_calls")
Fscore_BFF_cluster_batch2 <- calculate_HTO_fscore(seu2, donor_list_batch2[1:8], "BFF_cluster_calls")
Fscore_BFF_cluster_batch3 <- calculate_HTO_fscore(seu3, donor_list_batch3[1:8], "BFF_cluster_calls")

Fscore_demuxmix_batch1 <- calculate_HTO_fscore(seu1, donor_list_batch1[1:8], "demuxmix_calls")
Fscore_demuxmix_batch2 <- calculate_HTO_fscore(seu2, donor_list_batch2[1:8], "demuxmix_calls")
Fscore_demuxmix_batch3 <- calculate_HTO_fscore(seu3, donor_list_batch3[1:8], "demuxmix_calls")
```

Put it all together for visualisation
```{r}
Fscore_matrix_batch1 <- data.frame("HTO" = c(HTO_list_batch1[1:8], "Median"),
                            "hashedDrops" = Fscore_hashedDrops_batch1,
                            "hashedDrops_default" = Fscore_hashedDrops_default_batch1,
                            "HTODemux" = Fscore_HTODemux_batch1,
                            "GMM_Demux" = Fscore_GMMDemux_batch1,
                            "deMULTIplex" = Fscore_deMULTIplex_batch1,
                            "BFF_raw" = Fscore_BFF_raw_batch1,
                            "BFF_cluster" = Fscore_BFF_cluster_batch1,
                            "demuxmix" = Fscore_demuxmix_batch1) %>%
  pivot_longer(cols = c("hashedDrops", "hashedDrops_default", 
                        "HTODemux", "GMM_Demux", "deMULTIplex", 
                        "BFF_raw", "BFF_cluster", "demuxmix"),
               names_to = "method",
               values_to = "Fscore")

Fscore_matrix_batch2 <- data.frame("HTO" = c(HTO_list_batch2[1:8], "Median"),
                            "hashedDrops" = Fscore_hashedDrops_batch2,
                            "hashedDrops_default" = Fscore_hashedDrops_default_batch2,
                            "HTODemux" = Fscore_HTODemux_batch2,
                            "GMM_Demux" = Fscore_GMMDemux_batch2,
                            "deMULTIplex" = Fscore_deMULTIplex_batch2,
                            "BFF_raw" = Fscore_BFF_raw_batch2,
                            "BFF_cluster" = Fscore_BFF_cluster_batch2,
                            "demuxmix" = Fscore_demuxmix_batch2) %>%
  pivot_longer(cols = c("hashedDrops", "hashedDrops_default", 
                        "HTODemux", "GMM_Demux", "deMULTIplex", 
                        "BFF_raw", "BFF_cluster", "demuxmix"),
               names_to = "method",
               values_to = "Fscore")

Fscore_matrix_batch3 <- data.frame("HTO" = c(HTO_list_batch3[1:8], "Median"),
                            "hashedDrops" = Fscore_hashedDrops_batch3,
                            "hashedDrops_default" = Fscore_hashedDrops_default_batch3,
                            "HTODemux" = Fscore_HTODemux_batch3,
                            "GMM_Demux" = Fscore_GMMDemux_batch3,
                            "deMULTIplex" = Fscore_deMULTIplex_batch3,
                            "BFF_raw" = Fscore_BFF_raw_batch3,
                            "BFF_cluster" = Fscore_BFF_cluster_batch3,
                            "demuxmix" = Fscore_demuxmix_batch3) %>%
  pivot_longer(cols = c("hashedDrops", "hashedDrops_default", 
                        "HTODemux", "GMM_Demux", "deMULTIplex", 
                        "BFF_raw", "BFF_cluster", "demuxmix"), 
               names_to = "method",
               values_to = "Fscore")
```

```{r}
plotcolours <- c("Black", brewer.pal(9, "Blues")[2:9])#, "deeppink", "deeppink3")

p1 <- ggplot(data = Fscore_matrix_batch1) +
  geom_bar(aes(x = method, y = Fscore, fill = forcats::fct_relevel(HTO, "Median", "Human-HTO-1","Human-HTO-2", "Human-HTO-3", "Human-HTO-4", "Human-HTO-5", "Human-HTO-6", "Human-HTO-7", "Human-HTO-8")),
           position = "dodge", stat = "identity") +
  scale_fill_manual(values = plotcolours) + 
  ylim(0, 1) +
  xlab("") + 
  theme(axis.text = element_text(size = 12)) + 
  labs(fill = "HTO") +
  labs(title = "Batch 1") +
  facet_wrap(~method, ncol = 4, scales = "free_x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

p2 <- ggplot(data = Fscore_matrix_batch2) +
  geom_bar(aes(x = method, y = Fscore, fill = forcats::fct_relevel(HTO, "Median", "Human-HTO-6","Human-HTO-7", "Human-HTO-9", "Human-HTO-10", "Human-HTO-12", "Human-HTO-13", "Human-HTO-14", "Human-HTO-15")),
           position = "dodge", stat = "identity") +
  scale_fill_manual(values = plotcolours) + 
  ylim(0, 1) +
  xlab("") +
  theme(axis.text = element_text(size = 12)) + 
  labs(fill = "HTO") +
  labs(title = "Batch 2") +
  facet_wrap(~method, ncol = 4, scales = "free_x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


p3 <- ggplot(data = Fscore_matrix_batch3) +
  geom_bar(aes(x = method, y = Fscore, fill = forcats::fct_relevel(HTO, "Median", "Human-HTO-6","Human-HTO-7", "Human-HTO-9", "Human-HTO-10", "Human-HTO-12", "Human-HTO-13", "Human-HTO-14", "Human-HTO-15")),
           position = "dodge", stat = "identity") +
    scale_fill_manual(values = plotcolours) + 
  ylim(0, 1) +
  xlab("") +
  theme(axis.text = element_text(size = 12)) + 
  labs(fill = "HTO") +
  labs(title = "Batch 3") +
  #coord_flip() +
  facet_wrap(~method, ncol = 4, scales = "free_x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```
```{r}
p1 
p2
p3
```

###Doublets to singlets

Also worried about whether any of these methods are assigning genetic doublets as singlets. Going to look at the fraction of genetic doublets that get assigned to each of the possible HTO categories.

```{r}
batch1_doublets <- seu1[, seu1$genetic_donor == "doublet"]
batch2_doublets <- seu2[, seu2$genetic_donor == "doublet"]
batch3_doublets <- seu3[, seu3$genetic_donor == "doublet"]
```

```{r}
batch1_doublet_doublet <- NULL
batch1_doublet_negative <- NULL
batch1_doublet_singlet <- NULL

batch2_doublet_doublet <- NULL
batch2_doublet_negative <- NULL
batch2_doublet_singlet <- NULL

batch3_doublet_doublet <- NULL
batch3_doublet_negative <- NULL
batch3_doublet_singlet <- NULL

for (method in method_calls) {
  batch1_doublet_doublet <- c(batch1_doublet_doublet, sum(seu1$genetic_donor == "doublet" & seu1[[method]] == "Doublet") / sum(seu1$genetic_donor == "doublet"))
  batch1_doublet_negative <- c(batch1_doublet_negative, sum(seu1$genetic_donor == "doublet" & seu1[[method]] == "Negative") / sum(seu1$genetic_donor == "doublet"))
  batch1_doublet_singlet <- c(batch1_doublet_singlet, sum(seu1$genetic_donor == "doublet" & Reduce("|", lapply(HTO_list_batch1[1:8], function(x) seu1[[method]] == x))) / sum(seu1$genetic_donor == "doublet"))
  
  batch2_doublet_doublet <- c(batch2_doublet_doublet, sum(seu2$genetic_donor == "doublet" & seu2[[method]] == "Doublet") / sum(seu2$genetic_donor == "doublet"))
  batch2_doublet_negative <- c(batch2_doublet_negative, sum(seu2$genetic_donor == "doublet" & seu2[[method]] == "Negative") / sum(seu2$genetic_donor == "doublet"))
  batch2_doublet_singlet <- c(batch2_doublet_singlet, sum(seu2$genetic_donor == "doublet" & Reduce("|", lapply(HTO_list_batch2[1:8], function(x) seu2[[method]] == x))) / sum(seu2$genetic_donor == "doublet"))
  
  batch3_doublet_doublet <- c(batch3_doublet_doublet, sum(seu3$genetic_donor == "doublet" & seu3[[method]] == "Doublet") / sum(seu3$genetic_donor == "doublet"))
  batch3_doublet_negative <- c(batch3_doublet_negative, sum(seu3$genetic_donor == "doublet" & seu3[[method]] == "Negative") / sum(seu3$genetic_donor == "doublet"))
  batch3_doublet_singlet <- c(batch3_doublet_singlet, sum(seu3$genetic_donor == "doublet" & Reduce("|", lapply(HTO_list_batch3[1:8], function(x) seu3[[method]] == x))) / sum(seu3$genetic_donor == "doublet"))
}

names(batch1_doublet_doublet) <- method_calls
names(batch1_doublet_negative) <- method_calls
names(batch1_doublet_singlet) <- method_calls

names(batch2_doublet_doublet) <- method_calls
names(batch2_doublet_negative) <- method_calls
names(batch2_doublet_singlet) <- method_calls

names(batch3_doublet_doublet) <- method_calls
names(batch3_doublet_negative) <- method_calls
names(batch3_doublet_singlet) <- method_calls
```

```{r}
batch1_doublet_assignments <- data.frame("method" = c("hashedDrops", "hashedDrops (default)", "HTODemux",
                                                      "GMM-Demux", "deMULTIplex", "BFF_raw",
                                                      "BFF_cluster", "demuxmix"),
                            "Doublets" = batch1_doublet_doublet,
                            "Negative" = batch1_doublet_negative,
                            "Singlet" = batch1_doublet_singlet) %>%
  pivot_longer(cols = c("Doublets", "Negative", "Singlet"), 
               names_to = "assignment",
               values_to = "fraction")

batch2_doublet_assignments <- data.frame("method" = c("hashedDrops", "hashedDrops (default)", "HTODemux",
                                                      "GMM-Demux", "deMULTIplex", "BFF_raw",
                                                      "BFF_cluster", "demuxmix"),
                            "Doublets" = batch2_doublet_doublet,
                            "Negative" = batch2_doublet_negative,
                            "Singlet" = batch2_doublet_singlet) %>%
  pivot_longer(cols = c("Doublets", "Negative", "Singlet"), 
               names_to = "assignment",
               values_to = "fraction")

batch3_doublet_assignments <- data.frame("method" = c("hashedDrops", "hashedDrops (default)", "HTODemux",
                                                      "GMM-Demux", "deMULTIplex", "BFF_raw",
                                                      "BFF_cluster", "demuxmix"),
                            "Doublets" = batch3_doublet_doublet,
                            "Negative" = batch3_doublet_negative,
                            "Singlet" = batch3_doublet_singlet) %>%
  pivot_longer(cols = c("Doublets", "Negative", "Singlet"), 
               names_to = "assignment",
               values_to = "fraction")
```

```{r}
doublet_colours <- c("black", "gray60", "firebrick1")

p1 <- ggplot(batch1_doublet_assignments) + 
  geom_bar(aes(x = method, y = fraction, fill = assignment),
           position = "dodge", stat = "identity") +
  ggtitle("Batch 1 (2041 doublets)") +
  ylim(0, 1) +
  facet_wrap(~method, ncol = 4, scales = "free_x") +
  scale_fill_manual(values = doublet_colours) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(),
        plot.margin = margin(0,0,0,0,"cm")) + NoLegend()
  
p2 <- ggplot(batch2_doublet_assignments) + 
  geom_bar(aes(x = method, y = fraction, fill = assignment),
           position = "dodge", stat = "identity") +
    ggtitle("Batch 2 (6463 doublets)") +
    ylim(0, 1) +
  facet_wrap(~method, ncol = 4, scales = "free_x") +
  scale_fill_manual(values = doublet_colours) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        plot.margin = margin(0,0,0,0,"cm")) 
  
p3 <- ggplot(batch3_doublet_assignments) + 
  geom_bar(aes(x = method, y = fraction, fill = assignment),
           position = "dodge", stat = "identity") +
    ggtitle("Batch 3 (11004 doublets)") +
    ylim(0, 1) +
  facet_wrap(~method, ncol = 4, scales = "free_x") +
  scale_fill_manual(values = doublet_colours) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(),
        plot.margin = margin(0,0,0,0,"cm")) + NoLegend()

p1 / p2 / p3 
```

#Cell line data.

##Data loading and reduction.

```{r}
lmo_counts <- read.csv(here("data", "lmo_counts.csv"), check.names = FALSE, row.names = 1)
lmo_donors <- read.csv(here("data", "lmo_donors.csv"), row.names = 1)
```

```{r}
seu_lmo <- CreateSeuratObject(counts = lmo_counts, assay = "HTO")
```
```{r}
seu_lmo$Barcode <- colnames(seu_lmo)
```

Add genetic donor information to Seurat objects
```{r}
seu_lmo$genetic_donor <- lmo_donors
```

```{r}
LMO_list <- c("BC1", "BC2", "BC3", "Doublet", "Negative")
donor_LMO_list <- list("donor_A" = "BC1", "donor_B" = "BC2", "donor_C" = "BC3", "Doublet" = "Doublet", "Negative" = "Negative")
LMO_donor_list <- list("BC1" = "donor_A", "BC2" = "donor_B", "BC3" = "donor_C", "Doublet" = "Doublet", "Negative" = "Negative")
```


```{r}
DefaultAssay(seu_lmo) <- "HTO"

seu_lmo <- NormalizeData(seu_lmo, assay = "HTO", normalization.method = "CLR")
seu_lmo <- ScaleData(seu_lmo, features = rownames(seu_lmo),
    verbose = FALSE)
seu_lmo <- RunPCA(seu_lmo, features = rownames(seu_lmo), approx = FALSE, verbose = FALSE)
seu_lmo <- RunTSNE(seu_lmo, dims = 1:3, perplexity = 100, check_duplicates = FALSE, verbose = FALSE)
```

```{r}
DimPlot(seu_lmo, group.by = "genetic_donor")
```


```{r}
df <- as.data.frame(t(seu_lmo[["HTO"]]@counts))
colnames(df) <- gsub("_", " ", LMO_donor_list[colnames(df)])
df %>%
  pivot_longer(cols = starts_with("donor")) %>%
  mutate(logged = log(value + 1)) %>%
  ggplot(aes(x = logged)) +
  xlab("log(counts)") +
  xlim(0.1,8) +
  ggtitle("Batch 1") +
  geom_density(adjust = 3) +
  facet_wrap(~name, scales = "fixed", ncol = 3)  -> p1

p1
```






